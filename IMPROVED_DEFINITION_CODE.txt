export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type'
};

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const { word, gradeLevel = 'simple' } = await req.json();
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    // 1. Check local database first
    const { data: dbEntry } = await supabase
      .from('word_definitions')
      .select('*')
      .eq('word', word.toLowerCase())
      .single();

    if (dbEntry) {
      return new Response(JSON.stringify({
        word: dbEntry.word,
        phonetic: dbEntry.phonetic || '',
        partOfSpeech: dbEntry.part_of_speech,
        definitions: {
          simple: dbEntry.definition_simple,
          medium: dbEntry.definition_medium,
          advanced: dbEntry.definition_advanced
        },
        example: dbEntry.example || '',
        synonyms: dbEntry.synonyms || [],
        antonyms: dbEntry.antonyms || [],
        source: dbEntry.source
      }), {
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }

    // 2. Try Free Dictionary API - simplify with AI
    const apiUrl = `https://api.dictionaryapi.dev/api/v2/entries/en/${word.toLowerCase()}`;
    const response = await fetch(apiUrl);

    if (response.ok) {
      const data = await response.json();
      const entry = data[0];
      const meaning = entry.meanings[0];
      const definition = meaning.definitions[0];

      const openaiKey = Deno.env.get('OPENAI_API_KEY');
      const simplifyResponse = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${openaiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [{
            role: 'system',
            content: `You are a children's dictionary writer. CRITICAL RULES:
1. Use ONLY the MOST COMMON meaning
2. Keep simple definitions under 8 words
3. Use only 2nd grade vocabulary
4. For nouns: name the category (banana=a fruit)
5. For adjectives: give simplest synonym (sufficient=enough)
6. NEVER use obscure meanings`
          },
          {
            role: 'user',
            content: `Simplify "${word}": "${definition.definition}". Return JSON: {"simple": "under 8 words, 2nd grade", "medium": "under 15 words, 5th grade", "advanced": "detailed, 7th+ grade"}`
          }],
          response_format: { type: 'json_object' }
        })
      });

      const simplifyData = await simplifyResponse.json();
      const simplified = JSON.parse(simplifyData.choices[0].message.content);

      const result = {
        word: entry.word,
        phonetic: entry.phonetic || '',
        partOfSpeech: meaning.partOfSpeech,
        definitions: simplified,
        example: definition.example || '',
        synonyms: meaning.synonyms?.slice(0, 3) || [],
        antonyms: meaning.antonyms?.slice(0, 3) || [],
        source: 'freedict-simplified'
      };

      await supabase.from('word_definitions').insert({
        word: result.word.toLowerCase(),
        phonetic: result.phonetic,
        part_of_speech: result.partOfSpeech,
        definition_simple: result.definitions.simple,
        definition_medium: result.definitions.medium,
        definition_advanced: result.definitions.advanced,
        example: result.example,
        synonyms: result.synonyms,
        antonyms: result.antonyms,
        source: 'freedict-simplified'
      });

      return new Response(JSON.stringify(result), {
        headers: { 'Content-Type': 'application/json', ...corsHeaders }
      });
    }

    // 3. Pure AI fallback
    const openaiKey = Deno.env.get('OPENAI_API_KEY');
    const aiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openaiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [{
          role: 'system',
          content: `Children's dictionary writer. RULES: 1) MOST COMMON meaning only 2) Under 8 words for simple 3) 2nd grade vocabulary 4) Never obscure meanings`
        },
        {
          role: 'user',
          content: `Define "${word}" for kids. JSON: {"word":"${word}","phonetic":"","partOfSpeech":"","definitions":{"simple":"under 8 words","medium":"under 15 words","advanced":"detailed"},"example":"","synonyms":[],"antonyms":[]}`
        }],
        response_format: { type: 'json_object' }
      })
    });

    const aiData = await aiResponse.json();
    const result = JSON.parse(aiData.choices[0].message.content);
    result.source = 'openai';

    await supabase.from('word_definitions').insert({
      word: result.word.toLowerCase(),
      phonetic: result.phonetic,
      part_of_speech: result.partOfSpeech,
      definition_simple: result.definitions.simple,
      definition_medium: result.definitions.medium,
      definition_advanced: result.definitions.advanced,
      example: result.example,
      synonyms: result.synonyms,
      antonyms: result.antonyms,
      source: 'openai'
    });

    return new Response(JSON.stringify(result), {
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });

  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json', ...corsHeaders }
    });
  }
});
